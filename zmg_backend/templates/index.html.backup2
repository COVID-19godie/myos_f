<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ZMG OS Pro</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* ================= 1. ç³»ç»Ÿå˜é‡ ================= */
        :root {
            --bg-color: #0f172a;
            --sidebar-bg: rgba(240, 240, 240, 0.9);
            --content-bg: rgba(255, 255, 255, 0.95);
            --hover-bg: rgba(0, 0, 0, 0.05);
            --select-bg: #cce8ff;
        }

        * { box-sizing: border-box; user-select: none; }
        body { margin: 0; overflow: hidden; font-family: -apple-system, "Segoe UI", sans-serif; background: var(--bg-color); height: 100vh; }
        
        /* å£çº¸ */
        #wallpaper {
            position: absolute; inset: 0; z-index: 0;
            background: url('https://images.unsplash.com/photo-1620121692029-d088224ddc74?q=80&w=2000') center/cover;
            transition: filter 0.3s;
        }

        /* æ‹–æ‹½é®ç½© */
        body.drag-over #wallpaper { filter: blur(5px) brightness(0.8); }

        /* ================= 2. æ¡Œé¢å›¾æ ‡ç³»ç»Ÿ ================= */
        #desktop {
            position: absolute; inset: 0 0 100px 0; z-index: 1;
            display: flex; flex-wrap: wrap; align-content: flex-start; padding: 20px; gap: 10px;
        }

        .icon {
            width: 80px; height: 90px; border-radius: 8px;
            display: flex; flex-direction: column; align-items: center; justify-content: flex-start;
            padding: 8px; cursor: default; transition: background 0.1s; position: relative;
        }
        .icon:hover { background: rgba(255,255,255,0.1); }
        .icon.selected { background: rgba(255,255,255,0.2); box-shadow: inset 0 0 0 1px rgba(255,255,255,0.3); }
        
        .icon-body {
            width: 48px; height: 48px; margin-bottom: 6px; position: relative;
            display: flex; align-items: center; justify-content: center;
        }

        .icon-text {
            color: white; font-size: 12px; text-align: center; line-height: 1.3;
            text-shadow: 0 1px 3px rgba(0,0,0,0.8);
            width: 100%; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;
            padding: 2px 4px; border-radius: 4px;
        }
        .icon.selected .icon-text { background: #0058d0; text-shadow: none; }

        /* å›¾æ ‡æ ·å¼å‡çº§ */
        .fa-icon-lg { font-size: 42px; color: #555; }
        .icon-img { width: 100%; height: 100%; object-fit: cover; border-radius: 8px; }
        
        /* ç‰¹å®šé¢œè‰² */
        .fa-file-pdf { color: #e74c3c; }
        .fa-file-word { color: #3498db; }
        .fa-file-excel { color: #27ae60; }
        .fa-folder { color: #f1c40f; }
        .fa-youtube { color: #ff0000; }
        .fa-bilibili { color: #fb7299; }

        /* ================= 3. çª—å£ç®¡ç† (Sidebar) ================= */
        .window {
            position: absolute; background: var(--content-bg); border-radius: 10px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.4), 0 0 0 1px rgba(0,0,0,0.1);
            width: 900px; height: 600px; top: 50px; left: 100px;
            display: flex; flex-direction: column; overflow: hidden;
            animation: popIn 0.2s ease-out; z-index: 100;
        }
        @keyframes popIn { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        .win-header {
            height: 36px; background: #eef0f2; border-bottom: 1px solid #dcdcdc;
            display: flex; align-items: center; padding: 0 16px; justify-content: space-between;
        }
        .win-controls { display: flex; gap: 8px; z-index: 2; }
        .win-btn { width: 12px; height: 12px; border-radius: 50%; border: 1px solid rgba(0,0,0,0.1); cursor: pointer; }
        .btn-close { background: #ff5f57; }
        .btn-min { background: #febc2e; }
        .btn-max { background: #28c840; }
        .win-title { font-size: 13px; font-weight: 600; color: #333; flex: 1; text-align: center; pointer-events: none; }

        .win-body {
            display: flex; height: calc(100% - 36px); /* å‡å»æ ‡é¢˜æ é«˜åº¦ */
            background: transparent;
        }
        .win-sidebar {
            width: 180px; background: var(--sidebar-bg); border-right: 1px solid #ddd;
            padding: 10px 0; display: flex; flex-direction: column; gap: 2px;
            backdrop-filter: blur(10px);
        }
        .sidebar-item {
            padding: 8px 15px; cursor: pointer; display: flex; align-items: center; gap: 10px;
            font-size: 13px; color: #444; transition: all 0.2s;
        }
        .sidebar-item:hover { background: var(--hover-bg); }
        .sidebar-item.active { background: var(--select-bg); color: #005a9e; font-weight: 600; }
        
        .win-content {
            flex: 1; padding: 10px; overflow-y: auto; background: var(--content-bg);
            display: flex; flex-wrap: wrap; align-content: flex-start; gap: 10px;
        }

        /* ================= 4. åº•éƒ¨ Dock ================= */
        #dock {
            position: absolute; bottom: 10px; left: 50%; transform: translateX(-50%);
            height: 64px; background: rgba(255, 255, 255, 0.2); backdrop-filter: blur(30px);
            border-radius: 18px; border: 1px solid rgba(255,255,255,0.15);
            display: flex; align-items: center; gap: 12px; padding: 0 16px; z-index: 5000;
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        }
        .dock-item {
            width: 48px; height: 48px; border-radius: 10px; background: rgba(255,255,255,0.1);
            display: flex; align-items: center; justify-content: center; font-size: 24px;
            cursor: pointer; transition: 0.2s cubic-bezier(0.25, 1, 0.5, 1);
        }
        .dock-item:hover { transform: scale(1.15) translateY(-10px); }
        .dock-sep { width: 1px; height: 32px; background: rgba(255,255,255,0.2); }

        /* ================= 5. å¯åŠ¨å° ================= */
        #launchpad {
            position: fixed; inset: 0; background: rgba(0,0,0,0.3); backdrop-filter: blur(50px);
            z-index: 6000; display: none; flex-direction: column; align-items: center; padding-top: 100px;
        }
        #launchpad.active { display: flex; }
        .lp-grid { display: grid; grid-template-columns: repeat(6, 1fr); gap: 40px; width: 80%; max-width: 1000px; }
        .lp-item { display: flex; flex-direction: column; align-items: center; cursor: pointer; transition: 0.2s; }
        .lp-item:hover { transform: scale(1.05); }
        .lp-icon { 
            width: 80px; height: 80px; border-radius: 20px; background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
            display: flex; align-items: center; justify-content: center; font-size: 40px; margin-bottom: 12px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.15);
        }
        .lp-text { color: white; font-weight: 500; }

        /* å³é”®èœå• */
        #ctx-menu {
            position: fixed; background: rgba(255,255,255,0.95); backdrop-filter: blur(10px);
            width: 180px; border-radius: 8px; box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            padding: 5px; z-index: 9999; display: none; border: 1px solid rgba(0,0,0,0.1);
        }
        .ctx-item { padding: 8px 12px; font-size: 13px; border-radius: 4px; cursor: default; display: flex; gap: 8px; }
        .ctx-item:hover { background: #007aff; color: white; }

        /* Toast */
        #toast {
            position: fixed; top: 20px; right: 20px; background: white; padding: 15px 25px; border-radius: 8px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2); transform: translateX(150%); transition: transform 0.3s; z-index: 10000;
            font-weight: 500; font-size: 14px;
        }
        #toast.show { transform: translateX(0); }
        .hidden-input { display: none; }

        /* å®‰è£…æ¨¡æ€æ¡† */
        #install-modal {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: white; border-radius: 10px; box-shadow: 0 20px 60px rgba(0,0,0,0.4);
            z-index: 99999; display: none; width: 400px; height: auto;
        }
    </style>
</head>
<body>
    <div id="wallpaper"></div>
    <div id="desktop"><div class="icon-grid" id="desktop-grid"></div></div>

    <div id="dock">
        <div class="dock-item" onclick="App.toggleLaunchpad()" title="å¼€å§‹">ğŸªŸ</div>
        <div class="dock-item" onclick="App.openPC()" title="æ–‡ä»¶èµ„æºç®¡ç†å™¨">ğŸ“</div>
        <div class="dock-item" onclick="App.showInstallModal()" title="å®‰è£… H5 åº”ç”¨">â•</div>
        <div style="width:1px; height:30px; background:rgba(255,255,255,0.3);"></div>
        <div id="dock-apps" style="display:flex; gap:12px;"></div>
    </div>

    <div id="install-modal" class="window" style="display:none; width:400px; height:auto; top:20%; left:35%; z-index:99999;">
        <div class="win-header">
            <div class="win-controls">
                <button class="win-btn btn-close" onclick="document.getElementById('install-modal').style.display='none'"></button>
                <button class="win-btn btn-min"></button>
                <button class="win-btn btn-max"></button>
            </div>
            <div class="win-title">å®‰è£… H5 åº”ç”¨</div>
            <div style="width:40px"></div>
        </div>
        <div style="padding:20px; background:white;">
            <div style="margin-bottom:10px;">
                <label>åº”ç”¨åç§°</label>
                <input type="text" id="h5-name" style="width:100%; padding:8px; margin-top:5px;">
            </div>
            <div style="margin-bottom:10px;">
                <label>ç½‘å€ (URL)</label>
                <input type="text" id="h5-url" style="width:100%; padding:8px; margin-top:5px;" placeholder="https://...">
            </div>
            <div style="margin-bottom:15px;">
                <label>é€‰æ‹©å›¾æ ‡</label>
                <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:5px; height:100px; overflow-y:auto; padding:5px; border:1px solid #eee;">
                    <i class="fa-brands fa-github fa-2x" onclick="App.selectIcon(this, 'fa-brands fa-github')"></i>
                    <i class="fa-brands fa-google fa-2x" onclick="App.selectIcon(this, 'fa-brands fa-google')"></i>
                    <i class="fa-brands fa-youtube fa-2x" onclick="App.selectIcon(this, 'fa-brands fa-youtube')"></i>
                    <i class="fa-brands fa-bilibili fa-2x" onclick="App.selectIcon(this, 'fa-brands fa-bilibili')"></i>
                    <i class="fa-brands fa-weixin fa-2x" onclick="App.selectIcon(this, 'fa-brands fa-weixin')"></i>
                    <i class="fa-brands fa-zhihu fa-2x" onclick="App.selectIcon(this, 'fa-brands fa-zhihu')"></i>
                    <i class="fa-solid fa-globe fa-2x" onclick="App.selectIcon(this, 'fa-solid fa-globe')"></i>
                    <i class="fa-solid fa-gamepad fa-2x" onclick="App.selectIcon(this, 'fa-solid fa-gamepad')"></i>
                    <i class="fa-solid fa-code fa-2x" onclick="App.selectIcon(this, 'fa-solid fa-code')"></i>
                    <i class="fa-solid fa-chart-line fa-2x" onclick="App.selectIcon(this, 'fa-solid fa-chart-line')"></i>
                </div>
                <input type="hidden" id="h5-icon" value="fa-solid fa-globe">
                <div id="selected-icon-preview" style="margin-top:5px; font-size:12px; color:#666;">å½“å‰é€‰æ‹©: ğŸŒ é€šç”¨</div>
            </div>
            <button onclick="App.installH5()" style="width:100%; padding:10px; background:#007aff; color:white; border:none; border-radius:5px; cursor:pointer;">ç«‹å³å®‰è£…</button>
        </div>
    </div>

    <div id="launchpad" onclick="if(event.target===this) App.toggleLaunchpad()">
        <input type="text" placeholder="æœç´¢åº”ç”¨..." style="background:rgba(255,255,255,0.2); border:none; padding:12px 20px; border-radius:10px; color:white; width:300px; margin-bottom:50px; text-align:center; font-size:16px; outline:none;">
        <div class="lp-grid" id="lp-grid"></div>
    </div>

    <div id="ctx-menu">
        <div class="ctx-item" onclick="App.openSelected()">ğŸ“‚ æ‰“å¼€</div>
        <div class="ctx-item" onclick="App.renameSelected()">âœï¸ é‡å‘½å</div>
        <div class="ctx-item" onclick="App.deleteSelected()" style="color:red">ğŸ—‘ï¸ åˆ é™¤</div>
        <div style="height:1px; background:#ddd; margin:4px 0"></div>
        <div class="ctx-item" onclick="App.showInstallModal()">ğŸ“¥ å®‰è£… H5 åº”ç”¨</div>
        <div class="ctx-item" onclick="App.createFolder()">ğŸ“ æ–°å»ºæ–‡ä»¶å¤¹</div>
    </div>

    <input type="file" id="file-input" class="hidden-input" onchange="App.handleUpload(this)">
    <input type="file" id="folder-input" class="hidden-input" webkitdirectory mozdirectory onchange="App.handleUpload(this, true)">
    <div id="toast"></div>

    <script>
        const API_BASE = '/api';
        
        const App = {
            token: localStorage.getItem('zmg_token'),
            zIndex: 100,
            windows: [],
            
            // ç«™ç‚¹å¯¼èˆª
            sites: [
                { name: 'GitHub', url: 'https://github.com', icon: 'fa-brands fa-github', color: '#24292e' },
                { name: 'Bilibili', url: 'https://www.bilibili.com', icon: 'fa-brands fa-bilibili', color: '#fb7299' },
                { name: 'YouTube', url: 'https://www.youtube.com', icon: 'fa-brands fa-youtube', color: '#ff0000' },
            ],

            init() {
                if(!this.token) this.login();
                this.refreshDesktop();
                this.renderLaunchpad();
                
                // äº‹ä»¶ç»‘å®š
                document.addEventListener('click', e => this.onClick(e));
                document.addEventListener('contextmenu', e => this.onCtxMenu(e));
                document.addEventListener('mousedown', e => this.onDragStart(e));
                document.addEventListener('mousemove', e => this.onDragMove(e));
                document.addEventListener('mouseup', e => this.onDragEnd(e));

                // å¤–éƒ¨æ‹–æ‹½
                const body = document.body;
                body.addEventListener('dragover', e => { e.preventDefault(); body.classList.add('drag-over'); });
                body.addEventListener('dragleave', e => { if(e.relatedTarget===null) body.classList.remove('drag-over'); });
                body.addEventListener('drop', e => this.onExternalDrop(e));
            },

            async login() {
                try {
                    const res = await fetch(API_BASE + '/auth/login/', {
                        method:'POST', headers:{'Content-Type':'application/json'},
                        body: JSON.stringify({username:'admin', password:'admin123'})
                    });
                    const data = await res.json();
                    if(data.access) {
                        this.token = data.access;
                        localStorage.setItem('zmg_token', this.token);
                        this.refreshDesktop();
                    }
                } catch(e) {}
            },

            // --- è·å–å›¾æ ‡ HTML ---
            getIconHtml(item) {
                if (item.type === 'category') {
                    return `<i class="fa-solid fa-folder fa-icon-lg" style="color:#f1c40f;"></i>`;
                }
                // ä¼˜å…ˆä½¿ç”¨åç«¯ä¼ æ¥çš„ icon_class
                if (item.data.icon_class) {
                    return `<i class="${item.data.icon_class} fa-icon-lg"></i>`;
                }
                // å¦‚æœæœ‰å°é¢å›¾ï¼Œæ˜¾ç¤ºå›¾ç‰‡
                if (item.data.cover) {
                    return `<img src="${item.data.cover}" class="icon-img">`;
                }
                // é»˜è®¤å›¾æ ‡
                return `<i class="fa-solid fa-file fa-icon-lg"></i>`;
            },

            // --- æ¸²æŸ“æ¡Œé¢ ---
            async refreshDesktop() {
                const grid = document.getElementById('desktop-grid');
                grid.innerHTML = '';
                const data = await this.req('/desktop/?parent_id=root');
                (data.results || data || []).forEach(item => {
                    const el = document.createElement('div');
                    el.className = 'icon';
                    el.ondblclick = () => this.openItem(item);
                    el.innerHTML = `
                        <div class="icon-body" style="background:none;">${this.getIconHtml(item)}</div>
                        <div class="icon-text">${item.title}</div>
                    `;
                    grid.appendChild(el);
                });
            },

            // --- åˆ›å»ºå¸¦ä¾§è¾¹æ çš„çª—å£ ---
            async createWindow(id, title, type, contentData) {
                if(this.windows.find(w=>w.id===id)) return this.focusWin(id);

                const win = document.createElement('div');
                win.className = 'window';
                win.id = 'win-' + id;
                win.style.zIndex = ++this.zIndex;
                win.style.left = '100px'; win.style.top = '50px';

                // ä¾§è¾¹æ  HTML (å¦‚æœæ˜¯æ–‡ä»¶å¤¹ç±»å‹)
                let bodyHtml = '';
                if (type === 'folder') {
                    // è·å–ä¾§è¾¹æ åˆ†ç±»åˆ—è¡¨
                    const categories = await this.req('/categories/');
                    let sidebarItems = categories.results.map(c => 
                        `<div class="sidebar-item" onclick="App.loadFolderContent('${c.id}', document.getElementById('win-${id}'), this)">
                            <i class="fa-solid fa-${c.icon || 'folder'}"></i> ${c.name}
                        </div>`
                    ).join('');
                    
                    // æ·»åŠ  "æ¡Œé¢" å’Œ "æ ¹ç›®å½•"
                    sidebarItems = `
                        <div class="sidebar-item" onclick="App.loadFolderContent('root', document.getElementById('win-${id}'), this)">
                            <i class="fa-solid fa-desktop"></i> æ¡Œé¢
                        </div>
                        ${sidebarItems}
                    `;

                    bodyHtml = `
                        <div class="win-sidebar">${sidebarItems}</div>
                        <div class="win-content" id="win-content-${id}">åŠ è½½ä¸­...</div>
                    `;
                } else {
                    bodyHtml = `<div style="width:100%; height:100%;">${contentData}</div>`;
                }

                win.innerHTML = `
                    <div class="win-header">
                        <div class="win-controls">
                            <button class="win-btn btn-close" onclick="App.closeWin('${id}')"></button>
                            <button class="win-btn btn-min" onclick="App.minWin('${id}')"></button>
                            <button class="win-btn btn-max" onclick="App.maxWin('${id}')"></button>
                        </div>
                        <div class="win-title">${title}</div>
                        <div style="width:40px"></div>
                    </div>
                    <div class="win-body" style="${type!=='folder'?'display:block':''}">${bodyHtml}</div>
                `;
                
                // æ‹–æ‹½ç»‘å®š
                const header = win.querySelector('.win-header');
                header.onmousedown = (e) => {
                    const sx = e.clientX - win.offsetLeft;
                    const sy = e.clientY - win.offsetTop;
                    const move = ev => { win.style.left=(ev.clientX-sx)+'px'; win.style.top=(ev.clientY-sy)+'px'; };
                    const stop = () => { document.removeEventListener('mousemove', move); document.removeEventListener('mouseup', stop); };
                    document.addEventListener('mousemove', move);
                    document.addEventListener('mouseup', stop);
                };

                document.body.appendChild(win);
                this.windows.push({id, el: win});
                this.addToDock(id, title);

                if (type === 'folder') {
                    // é»˜è®¤åŠ è½½æŒ‡å®šæ–‡ä»¶å¤¹
                    this.loadFolderContent(contentData, win);
                }
            },

            focusWin(id) {
                const win = this.windows.find(w => w.id === id);
                if(win) {
                    win.el.style.zIndex = ++this.zIndex;
                }
            },

            closeWin(id) {
                const idx = this.windows.findIndex(w => w.id === id);
                if(idx >= 0) {
                    this.windows[idx].el.remove();
                    this.windows.splice(idx, 1);
                }
            },

            minWin(id) { /* TODO */ },
            maxWin(id) { /* TODO */ },

            addToDock(id, title) {
                const dockApps = document.getElementById('dock-apps');
                const exist = dockApps.querySelector(`[data-win-id='${id}']`);
                if(!exist) {
                    const div = document.createElement('div');
                    div.className = 'dock-item';
                    div.dataset.winId = id;
                    div.title = title;
                    div.innerHTML = 'ğŸ“„';
                    div.onclick = () => this.focusWin(id);
                    dockApps.appendChild(div);
                }
            },

            // --- åŠ è½½æ–‡ä»¶å¤¹å†…å®¹åˆ°å³ä¾§åŒºåŸŸ ---
            async loadFolderContent(parentId, winEl, sidebarItemEl) {
                const contentDiv = winEl.querySelector('.win-content');
                if(!contentDiv) return;

                // ä¾§è¾¹æ é«˜äº®å¤„ç†
                if(sidebarItemEl) {
                    winEl.querySelectorAll('.sidebar-item').forEach(i=>i.classList.remove('active'));
                    sidebarItemEl.classList.add('active');
                }

                contentDiv.innerHTML = '<div style="color:#888; width:100%; text-align:center; padding-top:20px;">åŠ è½½ä¸­...</div>';
                
                const data = await this.req(`/desktop/?parent_id=${parentId}`);
                const list = data.results || data || [];
                
                contentDiv.innerHTML = '';
                if(list.length === 0) contentDiv.innerHTML = '<div style="color:#ccc; width:100%; text-align:center; margin-top:50px;">æ­¤æ–‡ä»¶å¤¹ä¸ºç©º</div>';

                list.forEach(item => {
                    const el = document.createElement('div');
                    el.className = 'icon'; // å¤ç”¨æ¡Œé¢å›¾æ ‡æ ·å¼
                    el.style.height = '90px'; 
                    el.style.margin = '5px';
                    el.innerHTML = `
                        <div class="icon-body" style="width:50px; height:50px; background:none;">
                            ${this.getIconHtml(item)}
                        </div>
                        <div class="icon-text" style="color:#333; text-shadow:none; width:70px;">${item.title}</div>
                    `;
                    el.ondblclick = () => this.openItem(item);
                    contentDiv.appendChild(el);
                });
            },

            // --- æ‰“å¼€é¡¹ç›® (æ”¯æŒ PDF é¢„è§ˆ) ---
            openItem(item) {
                if(item.type === 'category') {
                    this.createWindow(item.id, item.title, 'folder', item.id);
                } else if(item.type === 'resource') {
                    const url = item.data.file || item.data.link;
                    if(!url) return;

                    // å¢å¼ºé¢„è§ˆé€»è¾‘
                    const ext = url.split('.').pop().toLowerCase();
                    // æµè§ˆå™¨åŸç”Ÿæ”¯æŒé¢„è§ˆçš„æ ¼å¼
                    if(['pdf', 'mp4', 'webm', 'mp3', 'jpg', 'png', 'gif', 'txt', 'html', 'py', 'css'].includes(ext) || item.data.kind === 'link') {
                        this.openIframe(item.title, url, 'ğŸ“„');
                    } else {
                        // å…¶ä»–æ ¼å¼ä¸‹è½½/æ–°æ ‡ç­¾é¡µæ‰“å¼€
                        window.open(url, '_blank');
                    }
                }
            },

            openIframe(title, url, icon) {
                const id = 'iframe-' + Date.now();
                const win = document.createElement('div');
                win.className = 'window';
                win.id = 'win-' + id;
                win.style.zIndex = ++this.zIndex;
                win.style.left = '150px'; win.style.top = '80px';
                win.style.width = '800px'; win.style.height = '600px';

                win.innerHTML = `
                    <div class="win-header" onmousedown="App.dragWin(event, '${id}')">
                        <div class="win-controls">
                            <button class="win-btn btn-close" onclick="document.getElementById('win-${id}').remove()"></button>
                            <button class="win-btn btn-min"></button><button class="win-btn btn-max"></button>
                        </div>
                        <div class="win-title">${icon} ${title}</div><div style="width:40px"></div>
                    </div>
                    <div class="win-body" style="padding:0;">
                        <iframe src="${url}" style="width:100%; height:100%; border:none;"></iframe>
                    </div>
                `;
                document.body.appendChild(win);
                this.windows.push({id, el: win});
                this.addToDock(id, title);
            },

            dragWin(e, id) {
                const win = document.getElementById('win-' + id);
                const sx = e.clientX - win.offsetLeft;
                const sy = e.clientY - win.offsetTop;
                const move = ev => { win.style.left=(ev.clientX-sx)+'px'; win.style.top=(ev.clientY-sy)+'px'; };
                const stop = () => { document.removeEventListener('mousemove', move); document.removeEventListener('mouseup', stop); };
                document.addEventListener('mousemove', move);
                document.addEventListener('mouseup', stop);
            },

            // --- H5 å®‰è£…é€»è¾‘ ---
            showInstallModal() { document.getElementById('install-modal').style.display = 'block'; },
            
            selectIcon(el, iconClass) {
                document.getElementById('h5-icon').value = iconClass;
                document.getElementById('selected-icon-preview').innerText = `å·²é€‰æ‹©: ${iconClass}`;
            },

            async installH5() {
                const name = document.getElementById('h5-name').value;
                const url = document.getElementById('h5-url').value;
                const icon = document.getElementById('h5-icon').value;

                if(!name || !url) return alert('è¯·å¡«å†™å®Œæ•´ä¿¡æ¯');

                try {
                    await this.req('/desktop/create_link/', 'POST', {
                        title: name,
                        link: url,
                        icon_class: icon,
                        x: 100, y: 100
                    });
                    document.getElementById('install-modal').style.display = 'none';
                    this.refreshDesktop();
                } catch(e) {
                    alert('å®‰è£…å¤±è´¥: éœ€åç«¯æ”¯æŒ create_link æ¥å£');
                }
            },

            // --- å…¶ä»–è¾…åŠ©æ–¹æ³• (ç®€åŒ–ç‰ˆ) ---
            onClick(e) {
                if(e.target.id==='desktop' || e.target.id==='wallpaper') {
                    document.querySelectorAll('.icon.selected').forEach(i=>i.classList.remove('selected'));
                    this.hideCtxMenu();
                }
            },
            onCtxMenu(e) {
                e.preventDefault();
                const menu = document.getElementById('ctx-menu');
                menu.style.display = 'block';
                menu.style.left = e.clientX+'px';
                menu.style.top = e.clientY+'px';
            },
            hideCtxMenu() { document.getElementById('ctx-menu').style.display = 'none'; },
            toggleLaunchpad() { document.getElementById('launchpad').classList.toggle('active'); },
            renderLaunchpad() {
                const box = document.getElementById('lp-grid');
                this.sites.forEach(s => {
                    const el = document.createElement('div');
                    el.className = 'lp-item';
                    el.innerHTML = `<div class="lp-icon" style="background:${s.color};color:white"><i class="${s.icon}"></i></div><div class="lp-text">${s.name}</div>`;
                    el.onclick = () => { window.open(s.url); this.toggleLaunchpad(); };
                    box.appendChild(el);
                });
            },
            showToast(msg) { 
                const t = document.getElementById('toast'); 
                t.innerText = msg; 
                t.classList.add('show'); 
                setTimeout(() => t.classList.remove('show'), 2000);
            },
            openPC() { this.createWindow('pc', 'æˆ‘çš„ç”µè„‘', 'folder', 'root'); },
            uploadTrigger() { document.getElementById('file-input').click(); },
            uploadFolderTrigger() { document.getElementById('folder-input').click(); },

            async handleUpload(input, isFolder = false) {
                const files = input.files;
                if (!files.length) return;
                this.showToast("ä¸Šä¼ åŠŸèƒ½å¾…å®Œå–„");
                input.value = '';
            },

            async req(url, method='GET', body=null, isForm=false) {
                const headers = { 'Authorization': `Bearer ${this.token}` };
                if (!isForm) headers['Content-Type'] = 'application/json';
                const res = await fetch(API_BASE + url, {
                    method,
                    headers,
                    body: isForm ? body : (body ? JSON.stringify(body) : null)
                });
                if (res.status === 401) { this.login(); throw new Error('Unauthorized'); }
                return res.json();
            },
        };

        window.onload = () => App.init();
    </script>
</body>
</html>